<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Mangrat Frontend</title>
<style>
  body { font-family: Arial, sans-serif; background: #1e1e1e; color: #fff; margin: 0; padding: 0; }
  #app { max-width: 600px; margin: 50px auto; padding: 20px; background: #2c2c2c; border-radius: 8px; }
  input, button { padding: 10px; margin: 5px 0; width: 100%; border-radius: 4px; border: none; }
  button { background: #4caf50; color: white; cursor: pointer; }
  button:hover { background: #45a049; }
  #chatLog { height: 200px; overflow-y: auto; background: #111; padding: 10px; margin-bottom: 10px; border-radius: 4px; }
  .message { margin: 5px 0; }
  .user { color: #4caf50; }
  .bot { color: #f1c40f; }
</style>
</head>
<body>
<div id="app">
  <h2>Mangrat Frontend</h2>
  
  <div id="chatLog"></div>
  <input type="text" id="chatInput" placeholder="Tape ton message..." />
  <button onclick="sendChat()">Envoyer</button>

  <hr>

  <input type="number" id="usdAmount" placeholder="Montant USD" />
  <button onclick="convertUSD()">Convertir en tokens</button>
  <div id="conversionResult"></div>
</div>

<script>
// ----- Ton token qui sert de "connexion" -----
const token = "sk-6ec147262d78ceba829992d2f8a144c0e6835b4a5ada98de";

// ----- URL interne cachée (non visible à l’utilisateur) -----
const _serverURL = "https://sarver-fullstack-4.onrender.com";

// ----- Chat -----
async function sendChat() {
  const input = document.getElementById("chatInput");
  const message = input.value;
  if (!message) return;

  appendMessage("user", message);
  input.value = "";

  try {
    const res = await fetch(_serverURL + "/chat", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ message })
    });
    const data = await res.json();
    appendMessage("bot", data.reply || "Pas de réponse.");
  } catch (e) {
    appendMessage("bot", "Erreur serveur.");
    console.error(e);
  }
}

function appendMessage(sender, text) {
  const chatLog = document.getElementById("chatLog");
  const div = document.createElement("div");
  div.className = "message " + sender;
  div.textContent = sender === "user" ? "Vous: " + text : "Mangrat: " + text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}

// ----- Conversion USD → tokens -----
async function convertUSD() {
  const amount = document.getElementById("usdAmount").value;
  if (!amount) return;

  try {
    const res = await fetch(_serverURL + "/user/convert", { // À adapter si ton endpoint diffère
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ from: "USD", to: "tokens", amount: parseFloat(amount) })
    });
    const data = await res.json();
    document.getElementById("conversionResult").textContent = `Résultat: ${data.converted || "Erreur"} tokens`;
  } catch (e) {
    document.getElementById("conversionResult").textContent = "Erreur serveur.";
    console.error(e);
  }
}
</script>
</body>
</html>
